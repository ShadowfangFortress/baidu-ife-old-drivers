!function(){"use strict";function e(e){return e.replace(/\*([^*]+)\*/g,function(e,t){return"<span class='medium'>"+t+"</span>"})}function t(t,o){var n="end";o&&"position"in o&&o.position&&(n=-1!==["start","end"].indexOf(o.position)?o.position:"end");var r,i=new Date(t.updated);switch(t.actionName){case"CreateDot":var c=[],a="project.html#pid="+t.params.project._id+"&sid="+t.params.screen._id;if(new Set(t.events.map(function(e){return e.source.username})).forEach(function(e){c.push(e)}),1===c.length){var l=t.events[0].source;r=document.importNode(document.querySelector(".notificationTemplate.createDotSingleUser").content,!0),Zeplin.setGravatar(r.querySelector(".dotAuthorImage"),l.email,{size:36}),r.querySelector(".dotAuthor").textContent=l.username}else{var p,d;r=document.importNode(document.querySelector(".notificationTemplate.createDotMultiUser").content,!0),c.length>3?(p=c.slice(0,3),d=c.length-3+" more people",r.querySelector(".tailUsername").title=c.slice(3).join("\n")):(d=c.pop(),p=c),r.querySelector(".headUsernames").textContent=p.join(", "),r.querySelector(".tailUsername").textContent=d}1===t.events.length?(a+="&did="+t.events[0].dot._id,r.querySelector(".notification").classList.add("withContent"),r.querySelector(".notificationContent").textContent=t.content,r.querySelector(".notificationContent").title=t.content):(r.querySelector(".dotCount").textContent=t.events.length,a+="&dids="+t.events.map(function(e){return e.dot._id}).join(",")),r.querySelector(".notification").href=a,r.querySelector(".screenName").textContent=t.params.screen.name,r.querySelector(".notificationProjectName").textContent=t.params.project.name,r.querySelector(".notificationProjectName").title=t.params.project.name,r.querySelector(".notificationProjectType").textContent=Zeplin.projectTypes[t.params.project.type];break;case"CreateDotComment":var c=[],a="project.html#pid="+t.params.project._id+"&sid="+t.params.screen._id+"&did="+t.params.dot._id;if(new Set(t.events.map(function(e){return e.source.username})).forEach(function(e){c.push(e)}),1===c.length){var l=t.events[0].source;r=document.importNode(document.querySelector(".notificationTemplate.createCommentSingleUser").content,!0),Zeplin.setGravatar(r.querySelector(".commentAuthorImage"),l.email,{size:36}),r.querySelector(".commentAuthor").textContent=l.username}else{r=document.importNode(document.querySelector(".notificationTemplate.createCommentMultiUser").content,!0);var p,d;c.length>3?(p=c.slice(0,3),d=c.length-3+" more people",r.querySelector(".tailUsername").title=c.slice(3).join("\n")):(d=c.pop(),p=c),r.querySelector(".headUsernames").textContent=p.join(", "),r.querySelector(".tailUsername").textContent=d}1===t.events.length?(a+="&cmid="+t.events[0].comment._id,r.querySelector(".notification").classList.add("withContent"),r.querySelector(".notificationContent").textContent=t.content,r.querySelector(".notificationContent").title=t.content):a+="&cmids="+t.events.map(function(e){return e.comment._id}).join(","),r.querySelector(".notification").href=a,r.querySelector(".noteName").textContent=t.params.dot.name,r.querySelector(".screenName").textContent=t.params.screen.name,r.querySelector(".notificationProjectName").textContent=t.params.project.name,r.querySelector(".notificationProjectName").title=t.params.project.name,r.querySelector(".notificationProjectType").textContent=Zeplin.projectTypes[t.params.project.type];break;case"CreateDot-Mention":case"CreateDotComment-Mention":var f=t.events[0],a="project.html#pid="+t.params.project._id+"&sid="+t.params.screen._id+"&did="+("CreateDot-Mention"===t.actionName?f.dot._id:t.params.dot._id)+"&cmid="+f.comment._id;r=document.importNode(document.querySelector(".notificationTemplate.commentMention").content,!0),r.querySelector(".notification").href=a,Zeplin.setGravatar(r.querySelector(".mentionAuthorImage"),f.source.email,{size:36}),r.querySelector(".mentionAuthor").textContent=f.source.username,r.querySelector(".noteName").textContent="CreateDot-Mention"===t.actionName?f.dot.name:t.params.dot.name,r.querySelector(".screenName").textContent=t.params.screen.name,r.querySelector(".notificationContent").textContent=t.content,r.querySelector(".notificationContent").title=t.content,r.querySelector(".notificationProjectName").textContent=t.params.project.name,r.querySelector(".notificationProjectName").title=t.params.project.name,r.querySelector(".notificationProjectType").textContent=Zeplin.projectTypes[t.params.project.type];break;case"CreateScreen":var a="project.html#pid="+t.params.project._id;if(1===t.events.length){var y=t.events[0].screen;a+="&sid="+y._id,r=document.importNode(document.querySelector(".notificationTemplate.createScreen").content,!0),r.querySelector(".screenName").textContent=y.name}else r=document.importNode(document.querySelector(".notificationTemplate.createScreenMulti").content,!0),r.querySelector(".screenCount").textContent=t.events.length,r.querySelector(".screenCount").title=t.events.map(function(e){return e.screen.name}).join("\n"),a+="&sids="+t.events.map(function(e){return e.screen._id}).join(",");r.querySelector(".notification").href=a,Zeplin.setGravatar(r.querySelector(".notifierImage"),t.params.source.email,{size:36}),r.querySelector(".notifier").textContent=t.params.source.username,r.querySelector(".notificationProjectName").textContent=t.params.project.name,r.querySelector(".notificationProjectName").title=t.params.project.name,r.querySelector(".notificationProjectType").textContent=Zeplin.projectTypes[t.params.project.type];break;case"CreateSnapshot":var a="project.html#pid="+t.params.project._id;if(1===t.events.length){var y=t.events[0].screen;a+="&sid="+y._id,r=document.importNode(document.querySelector(".notificationTemplate.updateScreen").content,!0),r.querySelector(".screenName").textContent=y.name}else r=document.importNode(document.querySelector(".notificationTemplate.updateScreenMulti").content,!0),r.querySelector(".screenCount").textContent=t.events.length,r.querySelector(".screenCount").title=t.events.map(function(e){return e.screen.name}).join("\n"),a+="&sids="+t.events.map(function(e){return e.screen._id}).join(",");r.querySelector(".notification").href=a,Zeplin.setGravatar(r.querySelector(".notifierImage"),t.params.source.email,{size:36}),r.querySelector(".notifier").textContent=t.params.source.username,r.querySelector(".notificationProjectName").textContent=t.params.project.name,r.querySelector(".notificationProjectName").title=t.params.project.name,r.querySelector(".notificationProjectType").textContent=Zeplin.projectTypes[t.params.project.type];break;case"DeleteScreen":if(1===t.events.length){var y=t.events[0].screen;r=document.importNode(document.querySelector(".notificationTemplate.deleteScreen").content,!0),r.querySelector(".screenName").textContent=y.name}else r=document.importNode(document.querySelector(".notificationTemplate.deleteScreenMulti").content,!0),r.querySelector(".screenCount").textContent=t.events.length,r.querySelector(".screenCount").title=t.events.map(function(e){return e.screen.name}).join("\n");Zeplin.setGravatar(r.querySelector(".notifierImage"),t.params.source.email,{size:36}),r.querySelector(".notifier").textContent=t.params.source.username,r.querySelector(".notificationProjectName").textContent=t.params.project.name,r.querySelector(".notificationProjectName").title=t.params.project.name,r.querySelector(".notificationProjectType").textContent=Zeplin.projectTypes[t.params.project.type];break;case"InviteUser":var a;if(t.events.length>1)r=document.importNode(document.querySelector(".notificationTemplate.inviteUserMulti").content,!0),r.querySelector(".projectCount").textContent=t.events.length,r.querySelector(".tailProject").textContent=t.events.pop().project.name,r.querySelector(".headProjects").textContent=t.events.map(function(e){return e.project.name}).join(", "),a="projects.html#pids="+t.events.map(function(e){return e.project._id}).join(",");else{var q=t.events[0].project;r=document.importNode(document.querySelector(".notificationTemplate.inviteUser").content,!0),r.querySelector(".projectName").textContent=q.name,a="project.html#pid="+q._id}r.querySelector(".notification").href=a;var v=t.params.source;Zeplin.setGravatar(r.querySelector(".notifierImage"),v.email,{size:36}),r.querySelector(".notifier").textContent=v.username;break;case"RemoveUserFromProject":var v=t.params.source;r=document.importNode(document.querySelector(".notificationTemplate.removeUser").content,!0),Zeplin.setGravatar(r.querySelector(".notifierImage"),v.email,{size:36}),r.querySelector(".notifier").textContent=v.username,r.querySelector(".projectName").textContent=t.params.project.name;break;case"UserJoined":if(t.events.length>1){r=document.importNode(document.querySelector(".notificationTemplate.newMemberMulti").content,!0);var p,d;t.events.length>3?(p=t.events.slice(0,3),d=t.events.length-3+" more",r.querySelector(".tailUsername").title=t.events.slice(3).map(function(e){return e.member.username}).join("\n")):(p=t.events.slice(0,t.events.length-1),d=t.events[t.events.length-1].member.username),r.querySelector(".headUsernames").textContent=p.map(function(e){return e.member.username}).join(", "),r.querySelector(".tailUsername").textContent=d}else{var C=t.events[0].member;r=document.importNode(document.querySelector(".notificationTemplate.newMember").content,!0),Zeplin.setGravatar(r.querySelector(".newMemberImage"),C.email,{size:36}),r.querySelector(".memberUsername").textContent=C.username}r.querySelector(".notification").href="project.html#pid="+t.params.project._id,r.querySelector(".projectName").textContent=t.params.project.name;break;case"DeleteProject":var v=t.params.source;r=document.importNode(document.querySelector(".notificationTemplate.deleteProject").content,!0),Zeplin.setGravatar(r.querySelector(".notifierImage"),v.email,{size:36}),r.querySelector(".notifier").textContent=v.username,r.querySelector(".projectName").textContent=t.events[0].project.name;break;case"ArchiveProject":var v=t.params.source;r=document.importNode(document.querySelector(".notificationTemplate.archiveProject").content,!0),Zeplin.setGravatar(r.querySelector(".notifierImage"),v.email,{size:36}),r.querySelector(".notifier").textContent=v.username,r.querySelector(".projectName").textContent=t.events[0].project.name;break;case"ActivateProject":var q=t.events[0].project,v=t.params.source;r=document.importNode(document.querySelector(".notificationTemplate.activateProject").content,!0),r.querySelector(".notification").href="project.html#pid="+q._id,Zeplin.setGravatar(r.querySelector(".notifierImage"),v.email,{size:36}),r.querySelector(".notifier").textContent=v.username,r.querySelector(".projectName").textContent=q.name;break;case"UpdateUserRole":var a;if(t.events.length>1)r=document.importNode(document.querySelector(".notificationTemplate.assignAdminMulti").content,!0),r.querySelector(".projectCount").textContent=t.events.length,r.querySelector(".tailProject").textContent=t.events.pop().project.name,r.querySelector(".headProjects").textContent=t.events.map(function(e){return e.project.name}).join(", "),a="projects.html#pids="+t.events.map(function(e){return e.project._id}).join(",");else{var q=t.events[0].project;r=document.importNode(document.querySelector(".notificationTemplate.assignAdmin").content,!0),r.querySelector(".projectName").textContent=q.name,a="project.html#pid="+q._id}r.querySelector(".notification").href=a;var v=t.params.source;Zeplin.setGravatar(r.querySelector(".notifierImage"),v.email,{size:36}),r.querySelector(".notifier").textContent=v.username;break;case"TransferOwnership":var q=t.events[0].project,v=t.params.source;r=document.importNode(document.querySelector(".notificationTemplate.transferOwnership").content,!0),r.querySelector(".notification").href="project.html#pid="+q._id,Zeplin.setGravatar(r.querySelector(".notifierImage"),v.email,{size:36}),r.querySelector(".notifier").textContent=v.username,r.querySelector(".projectName").textContent=q.name;break;case"CreateColor":var a="project.html#pid="+t.params.project._id+"&styleguide";if(t.events.length>1)r=document.importNode(document.querySelector(".notificationTemplate.createColorMulti").content,!0),r.querySelector(".colorCount").textContent=t.events.length,r.querySelector(".colorCount").title=t.events.map(function(e){var o=new Zeplin.Color(e.color);return o.name+": "+o.toPlatformString(t.params.project.type)}).join("\n"),a+="&cids="+t.events.map(function(e){return e.color._id}).join(",");else{var j=new Zeplin.Color(t.events[0].color);r=document.importNode(document.querySelector(".notificationTemplate.createColor").content,!0),r.querySelector(".colorPreview").style.backgroundColor=j.toCSS(),r.querySelector(".colorPreview").title=j.toPlatformString(t.params.project.type),r.querySelector(".notificationColorName").textContent=j.name,r.querySelector(".notificationColorName").title=j.toPlatformString(t.params.project.type),a+="&cid="+t.events[0].color._id}r.querySelector(".notification").href=a,r.querySelector(".notifier").textContent=t.params.source.username,r.querySelector(".notificationProjectName").textContent=t.params.project.name,r.querySelector(".notificationProjectName").title=t.params.project.name,r.querySelector(".notificationProjectType").textContent=Zeplin.projectTypes[t.params.project.type];break;case"DeleteColor":if(t.events.length>1)r=document.importNode(document.querySelector(".notificationTemplate.deleteColorMulti").content,!0),r.querySelector(".colorCount").textContent=t.events.length,r.querySelector(".colorCount").title=t.events.map(function(e){var o=new Zeplin.Color(e.color);return o.name+": "+o.toPlatformString(t.params.project.type)}).join("\n");else{var j=new Zeplin.Color(t.events[0].color);r=document.importNode(document.querySelector(".notificationTemplate.deleteColor").content,!0),r.querySelector(".colorPreview").style.backgroundColor=j.toCSS(),r.querySelector(".colorPreview").title=j.toPlatformString(t.params.project.type),r.querySelector(".notificationColorName").textContent=j.name,r.querySelector(".notificationColorName").title=j.toPlatformString(t.params.project.type)}r.querySelector(".notifier").textContent=t.params.source.username,r.querySelector(".notificationProjectName").textContent=t.params.project.name,r.querySelector(".notificationProjectName").title=t.params.project.name,r.querySelector(".notificationProjectType").textContent=Zeplin.projectTypes[t.params.project.type];break;case"UpdateColor":var a="project.html#pid="+t.params.project._id+"&styleguide";if(t.events.length>1)r=document.importNode(document.querySelector(".notificationTemplate.updateColorMulti").content,!0),r.querySelector(".colorCount").textContent=t.events.length,r.querySelector(".colorCount").title=t.events.map(function(e){var o=new Zeplin.Color(e.color);return o.name+": "+o.toPlatformString(t.params.project.type)}).join("\n"),a+="&cids="+t.events.map(function(e){return e.color._id}).join(",");else{var j=new Zeplin.Color(t.events[0].color);r=document.importNode(document.querySelector(".notificationTemplate.updateColor").content,!0),r.querySelector(".colorPreview").style.backgroundColor=j.toCSS(),r.querySelector(".colorPreview").title=j.toPlatformString(t.params.project.type),r.querySelector(".notificationColorName").textContent=j.name,r.querySelector(".notificationColorName").title=j.toPlatformString(t.params.project.type),a+="&cid="+t.events[0].color._id}r.querySelector(".notification").href=a,r.querySelector(".notifier").textContent=t.params.source.username,r.querySelector(".notificationProjectName").textContent=t.params.project.name,r.querySelector(".notificationProjectName").title=t.params.project.name,r.querySelector(".notificationProjectType").textContent=Zeplin.projectTypes[t.params.project.type];break;case"CreateCoupon":r=document.importNode(document.querySelector(".notificationTemplate.createCoupon").content,!0),r.querySelector(".notification").href=t.action.webURI,r.querySelector(".notificationContent").innerHTML=e(t.content),i>S&&m.classList.contains("hidden")&&s.classList.add("hasPromotion");break;case"AuthSlack":var q=t.events[0].project,v=t.params.source;r=document.importNode(document.querySelector(".notificationTemplate.authSlack").content,!0),r.querySelector(".notification").href="project.html#pid="+q._id,r.querySelector(".notifier").textContent=v.username,r.querySelector(".projectName").textContent=q.name,r.querySelector(".slackChannel").textContent=t.content;break;case"CreateAnnouncement":if(!("webURI"in t.action))return;r=document.importNode(document.querySelector(".notificationTemplate.announcement").content,!0),r.querySelector(".notification").href=t.action.webURI||"#",r.querySelector(".notificationContent").innerHTML=e(t.content),r.querySelector(".notificationAnnouncer").textContent=t.params.source.username,t.action.webURI||(r.querySelector(".notification").classList.add("noClick"),r.querySelector(".notification").addEventListener("click",function(e){e.preventDefault(),e.stopPropagation()}));break;default:r=document.importNode(document.querySelector(".notificationTemplate.undefinedNotification").content,!0)}switch(i>S&&m.classList.contains("hidden")&&s.classList.add("hasUnread"),r.querySelector(".notification").dataset.id=t._id,r.querySelector(".notification").classList.toggle("new",i>S),r.querySelector(".notificationLastUpdated").setAttribute("datetime",t.updated),n){case"start":u.children.length?u.insertBefore(r,u.firstElementChild):u.appendChild(r);break;case"end":default:u.appendChild(r)}}function o(e){for(var t=0,o=0;o<q.length;o++)if(q[o]._id===e[0]._id){t=q.splice(o).length;break}return q=q.concat(e),t}function n(){m.classList.contains("error")||y||f||(f=!0,fetch(Zeplin.urls.baseURL+"/notifications?offset="+q.length+"&count="+l,{headers:Zeplin.headers}).then(function(e){return e.json().then(function(t){if(e.ok)return t;throw Zeplin.createError(e.status,t)})}).then(function(e){if(!e.notifications.length)return y=!0,void m.classList.add("fin");for(var r=o(e.notifications),i=r;i<e.notifications.length;i++)t(e.notifications[i]);if(f=!1,e.notifications.length<l)y=!0,m.classList.add("fin");else{var c=m.scrollHeight,a=m.clientHeight,s=m.scrollTop;!m.classList.contains("hidden")&&360>c-(a+s)&&n()}})["catch"](function(e){console.error(e),m.classList.add("error"),e instanceof ServerError?console.error(e.alertMessage):e instanceof ClientError&&(console.error(e.alertMessage),401===e.status&&(Cookies.expire("userToken"),localStorage.removeItem("user"),sessionStorage.setItem("redirectTo",location.href),location.replace("login.html")))}))}function r(){s.classList.remove("hasUnread","hasPromotion")}function i(){[].forEach.call(u.querySelectorAll(".notification"),function(e){e.classList.remove("new")})}function c(){S=new Date,fetch(Zeplin.urls.baseURL+"/users/notificationLastReadTime",{method:"PUT",headers:Zeplin.headers}).then(function(e){return e.json().then(function(t){if(e.ok)return t;throw Zeplin.createError(e.status,t)})}).then(function(e){Zeplin.getUserInfo().then(function(t){t.notificationLastReadTime=e.notificationLastReadTime,S=new Date(e.notificationLastReadTime),localStorage.setItem("user",JSON.stringify(t))})})["catch"](function(e){e instanceof ServerError?console.error(e.alertMessage):e instanceof ClientError?(console.error(e.alertMessage),401===e.status&&(Cookies.expire("userToken"),localStorage.removeItem("user"),sessionStorage.setItem("redirectTo",location.href),location.replace("login.html"))):Zeplin.createDialog()}).then(r,r)}var a,l=50,s=document.getElementById("notificationsButton"),m=document.getElementById("notificationContainer"),u=document.getElementById("notificationList"),p=document.getElementById("notificationError"),d=document.getElementById("userMenu"),f=!1,y=!1,S=new Date,q=[];s.addEventListener("click",function(e){if(e.stopPropagation(),e.button===Zeplin.MOUSE_BUTTON.LEFT)if(d.classList.add("hidden"),m.classList.toggle("hidden"),m.classList.contains("hidden"))clearTimeout(a);else{var t=m.scrollHeight,o=m.clientHeight,r=m.scrollTop;360>t-(o+r)&&n()}});var v=new MutationObserver(function(e){e.forEach(function(e){"class"!==e.attributeName||e.oldValue&&-1!==e.oldValue.indexOf("hidden")||!e.target.classList.contains("hidden")||(i(),c())})});v.observe(m,{attributes:!0}),u.addEventListener("click",function(e){if(e.stopPropagation(),e.button===Zeplin.MOUSE_BUTTON.LEFT){for(var t=e.target;!t.classList.contains("notification");)t=t.parentElement;"A"===t.tagName&&m.classList.add("hidden")}}),m.addEventListener("scroll",function(e){requestAnimationFrame(function(){var e=m.scrollHeight,t=m.clientHeight,o=m.scrollTop;360>e-(t+o)&&n()})}),p.addEventListener("click",function(e){e.stopPropagation(),e.button===Zeplin.MOUSE_BUTTON.LEFT&&(m.classList.remove("error"),n())}),document.addEventListener("click",function(e){e.button===Zeplin.MOUSE_BUTTON.LEFT&&m.classList.add("hidden")}),document.addEventListener("keydown",function(e){e.keyCode===Zeplin.KEY_CODE.ESC&&m.classList.add("hidden")}),Zeplin.userInfoPromise.then(function(e){S=new Date(e.notificationLastReadTime),n();var o=Zeplin.pusher.channel("private-user@"+e._id);o.bind("Notification",function(e){for(var o=0;o<q.length;o++)if(q[o]._id===e.body._id){q.splice(o,1);var n=u.querySelector(".notification[data-id='"+e.body._id+"']");n&&n.remove();break}q.unshift(e.body),t(e.body,{position:"start"})})});var C=Zeplin.pusher.subscribe("announcement");C.bind("Notification",function(e){q.unshift(e.body),t(e.body,{position:"start"})}),window.addEventListener("online",function(){q=[],f=!1,y=!1,u.innerHTML="",m.classList.remove("fin","error"),r(),n()})}();