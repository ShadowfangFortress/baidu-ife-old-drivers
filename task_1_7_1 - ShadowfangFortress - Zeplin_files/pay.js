!function(){"use strict";function e(e){switch(e){case 1:return"1 active project";case 999:return"Unlimited projects";default:return e+" active projects"}}function t(e){Zeplin.getPlans().then(function(t){for(var o,r=0;r<t.length;r++)if(t[r]._id===e){o=t[r];break}if(!o)throw new ClientError(404,"Plan not found","We couldn't recognize your current plan.");if(d=o.price){var a=e.split("_");l=a[0],u=a[1]||"monthly",p=l,m=u}else{l=e,u="monthly",p=l,m=u;var s=document.querySelector(".plan.free");s.classList.add(e),s.dataset.planId=e,s.querySelector(".planName").textContent=o.name,"banker_bilo"===e?y.querySelector("button").textContent="💰💰💰":"bff"===e&&(y.querySelector("button").textContent="💝")}v.textContent=o.name,"period"in Z?(n(Z.period),document.getElementById(Z.period+"Payment").checked=!0,delete Z.period,E.classList.remove("hidden")):(n(u),document.getElementById(u+"Payment").checked=!0),"coupon"in Z&&(I.value=Z.coupon,I.parentElement.classList.toggle("typed",!!I.value),i(Z.coupon),delete Z.coupon,E.classList.remove("hidden"))})["catch"](function(e){console.error(e),(e instanceof ServerError||e instanceof ClientError)&&Zeplin.createDialog({title:e.title,message:e.message})})}function n(t,n){Zeplin.getPlans().then(function(o){var i=document.querySelector(".plan.growing"),a=document.querySelector(".plan.current"),s=document.querySelectorAll(".plan.borderless");if(m=t,S.classList.toggle("hidden","annual"===t),Array.prototype.forEach.call(document.querySelectorAll(".plan"),function(i){for(var a,s=0;s<o.length;s++){var c=i.dataset.planId+(o[s].price?"_"+t:"");if(o[s]._id===c){a=o[s];break}}if(!a)throw new ClientError(404,"Plan not found","We couldn't recognize your current plan.");var l="monthly"===t?a.price:a.price/12,u=i.querySelector(".planPrice"),d=i.querySelector(".planProjectCount"),p=r(m,n);p&&(l-=n.percent_off?l*n.percent_off/100:n.amount_off,l=Math.max(l,0)),u.textContent=l/100,u.setAttribute("value",l),u.classList.toggle("hasDiscount",p),d.textContent=e(a.limit)}),a&&a.classList.remove("current"),Array.prototype.forEach.call(s,function(e){e.classList.remove("borderless")}),"free"===l||"starter"===l||"growing"===l&&"monthly"===u&&"annual"===t?(i.classList.add("recommended"),i.previousElementSibling.classList.add("borderless")):i.classList.remove("recommended"),!d||t===u){document.querySelector(".plan."+l).classList.add("current");var c=document.querySelector(".plan.current").previousElementSibling;c&&c.classList.add("borderless")}})["catch"](function(e){console.error(e.alertMessage),(e instanceof ServerError||e instanceof ClientError)&&Zeplin.createDialog({title:e.title,message:e.message})})}function o(e){return e?fetch(Zeplin.urls.baseURL+"/stripe/coupons/"+encodeURIComponent(e),{headers:Zeplin.headers}).then(function(e){return e.json().then(function(t){if(!e.ok)throw Zeplin.createError(e.status,t);return t})})["catch"](function(e){if(console.error(e),e instanceof ClientError&&401===e.status)return Cookies.expire("userToken"),localStorage.removeItem("user"),sessionStorage.setItem("redirectTo",location.href),void Zeplin.createDialog({title:e.title,message:e.message,done:{name:"OK",cb:function(){location.replace("login.html")}}});throw e}):Promise.resolve(null)}function r(e,t){if(!t||"annual"===e)return L.innerHTML="&nbsp;",!1;if(t.redeem_by&&Date.now()/1e3>t.redeem_by)return L.textContent="This coupon is expired.",!1;if(t.max_redemptions&&t.times_redeemed>=t.max_redemptions)return L.textContent="This coupon is maxed out.",!1;var n=t.percent_off?t.percent_off+"% off":t.amount_off/100+"$ off";switch(t.duration){case"once":n+=" for the first "+("monthly"===e?"month":"year");break;case"repeating":n+=" for "+t.duration_in_months+" months";break;case"forever":n+=" forever"}return L.textContent=n,!0}function i(e){o(e).then(function(e){f=e,n(m,e)})["catch"](function(e){f=void 0,n(m),Zeplin.createDialog({message:e})})}function a(e,t){g.classList.remove("hidden"),Zeplin.getUserInfo().then(function(n){fetch(Zeplin.urls.baseURL+"/stripe/subscriptions",{method:"POST",headers:Zeplin.headers,body:JSON.stringify({email:n.email,plan:e+"_"+m,coupon:"monthly"===m?f&&f.id:void 0,stripeToken:t})}).then(function(e){return e.ok?void 0:e.json().then(function(t){throw Zeplin.createError(e.status,t)})}).then(function(){n.paymentPlan=e+"_"+m,localStorage.setItem("user",JSON.stringify(n)),location.replace("thanks.html")})["catch"](function(e){console.error(e),e instanceof ServerError?Zeplin.createDialog({title:"Could not process the transaction",message:"Please try again with another card or contact your bank. Let us know if the issue continues: support@zeplin.io"}):e instanceof ClientError?Zeplin.createDialog({title:e.title,message:e.message,done:{name:"OK",cb:function(){401===e.status&&(Cookies.expire("userToken"),localStorage.removeItem("user"),sessionStorage.setItem("redirectTo",location.href),location.replace("login.html"))}}}):Zeplin.createDialog(),g.classList.add("hidden")})})}function s(e){g.classList.remove("hidden"),fetch(Zeplin.urls.baseURL+"/stripe/subscriptions",{method:"PUT",headers:Zeplin.headers,body:JSON.stringify({plan:e+"_"+m,coupon:"monthly"===m?f&&f.id:void 0})}).then(function(e){return e.ok?void 0:e.json().then(function(t){throw Zeplin.createError(e.status,t)})}).then(function(){return Zeplin.getUserInfo()}).then(function(t){t.paymentPlan=e+"_"+m,localStorage.setItem("user",JSON.stringify(t)),location.replace("thanks.html")})["catch"](function(e){console.error(e),e instanceof ServerError?Zeplin.createDialog({title:"Could not change plan",message:"Please try again with another card or contact your bank. Let us know if the issue continues: support@zeplin.io"}):e instanceof ClientError?Zeplin.createDialog({title:e.title,message:e.message,done:{name:"OK",cb:function(){401===e.status&&(Cookies.expire("userToken"),localStorage.removeItem("user"),sessionStorage.setItem("redirectTo",location.href),location.replace("login.html"))}}}):Zeplin.createDialog(),g.classList.add("hidden")})}function c(){g.classList.remove("hidden"),fetch(Zeplin.urls.baseURL+"/stripe/subscriptions",{method:"DELETE",headers:Zeplin.headers}).then(function(e){return e.ok?void 0:e.json().then(function(t){throw Zeplin.createError(e.status,t)})}).then(function(){return Zeplin.getUserInfo()}).then(function(e){e.paymentPlan="free",localStorage.setItem("user",JSON.stringify(e)),Zeplin.createDialog({title:"Subscription cancelled successfully",message:"It's sad to see you go. Let us know if there's anything bothering you: support@zeplin.io",done:{name:"OK",cb:function(){location.replace("projects.html")}}})})["catch"](function(e){console.error(e),e instanceof ServerError?Zeplin.createDialog({title:e.title,message:e.message}):e instanceof ClientError?Zeplin.createDialog({title:e.title,message:e.message,done:{name:"OK",cb:function(){401===e.status&&(Cookies.expire("userToken"),localStorage.removeItem("user"),sessionStorage.setItem("redirectTo",location.href),location.replace("login.html"))}}}):Zeplin.createDialog(),g.classList.add("hidden")})}if(Cookies.get("userToken")){var l,u,d,p,m,f,g=document.getElementById("loading"),h=document.getElementById("userMenu"),y=document.getElementById("updatePlanButton"),v=document.getElementById("planName"),E=document.getElementById("planChooserOverlay"),b=document.getElementById("planChooser"),L=document.getElementById("discountNotice"),S=document.getElementById("couponForm"),I=document.getElementById("couponCode"),k=document.getElementById("pricingTable"),C=document.getElementById("cancelPlanButton"),Z={};location.hash&&location.hash.substr(1).split("&").forEach(function(e){var t=e.split("=");Z[decodeURIComponent(t[0])]=decodeURIComponent(t[1])});var P=StripeCheckout.configure({key:"pk_live_XfHC5uYDKaZYEOC1m9FlXwtq",image:"../img/favicon/128x128.png",token:function(e){g.classList.remove("hidden"),a(p,e.id)}});Array.prototype.forEach.call(document.querySelectorAll("[name='paymentPeriod']"),function(e){e.addEventListener("change",function(e){n(e.target.value,f)})}),I.parentElement.classList.toggle("typed",!!I.value),I.addEventListener("keyup",function(){I.parentElement.classList.toggle("typed",!!I.value),I.value||(f=void 0,n(m))}),I.addEventListener("blur",function(){I.parentElement.classList.toggle("typed",!!I.value),I.value||(f=void 0,n(m))}),S.addEventListener("submit",function(e){e.preventDefault(),i(I.value)}),k.addEventListener("click",function(e){for(var t=e.target;"TR"!==t.nodeName;)t=t.parentElement;if(!t.classList.contains("free")&&!t.classList.contains("current"))if(p=t.dataset.planId,d)Zeplin.createDialog({title:"Update subscription?",message:"You can update it again, anytime!",done:{name:"UPDATE",cb:function(){s(p)}},cancel:{name:"CANCEL"}});else{var n,o=parseInt(t.querySelector("data").getAttribute("value"),10);"monthly"===m?n="Pay {{amount}}/mo":(n="Pay {{amount}}/year",o*=12),o||(n="Pay 0/mo"),Zeplin.getUserInfo().then(function(e){P.open({name:"Zeplin, Inc.",description:t.querySelector(".planName").textContent,email:e.email,panelLabel:n,amount:o})})}}),C.addEventListener("click",function(e){e.stopPropagation(),Zeplin.createDialog({title:"Cancel subscription?",message:"Make sure to archive your projects before.",done:{name:"CANCEL",cb:function(){c()}},cancel:{name:"KEEP"}})}),b.addEventListener("click",function(e){e.stopPropagation()}),E.addEventListener("click",function(){E.classList.add("hidden")}),E.addEventListener("keydown",function(e){e.stopPropagation()}),document.addEventListener("keydown",function(e){e.keyCode===Zeplin.KEY_CODE.ESC&&E.classList.add("hidden")}),y.addEventListener("click",function(e){e.preventDefault(),h.classList.add("hidden"),E.classList.remove("hidden")}),Zeplin.userInfoPromise.then(function(e){t(e.paymentPlan);var o=Zeplin.pusher.channel("private-user@"+e._id);o.bind("CreateSubscription",function(e){t(e.body.plan),n(u),document.getElementById(u+"Payment").checked=!0,Zeplin.getUserInfo().then(function(t){t.paymentPlan=e.body.plan,localStorage.setItem("user",JSON.stringify(t))})}),o.bind("UpdateSubscription",function(e){t(e.body.plan),n(u),document.getElementById(u+"Payment").checked=!0,Zeplin.getUserInfo().then(function(t){t.paymentPlan=e.body.plan,localStorage.setItem("user",JSON.stringify(t))})}),o.bind("CancelSubscription",function(){t("free"),n(u),document.getElementById(u+"Payment").checked=!0,Zeplin.getUserInfo().then(function(e){e.paymentPlan="free",localStorage.setItem("user",JSON.stringify(e))})})})}}();